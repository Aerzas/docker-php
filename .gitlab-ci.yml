variables:
  DOCKER_DRIVER: overlay2
  DRUSH_LAUNCHER_VERSION: 0.6.0
  PHP72_BASE_IMAGE: php:7.2.29-fpm-alpine3.11
  PHP73_BASE_IMAGE: php:7.3.16-fpm-alpine3.11
  PHP74_BASE_IMAGE: php:7.4.4-fpm-alpine3.11

stages:
  - build
  - build-dev
  - build-drupal

.build: &build
  only:
    - tags
  image:
    name: gcr.io/kaniko-project/executor:debug
    entrypoint: [""]
  before_script:
    - echo "{\"auths\":{\"${DOCKERHUB_REGISTRY}\":{\"username\":\"${DOCKERHUB_USER}\",\"password\":\"${DOCKERHUB_PASSWORD}\"}}}" > /kaniko/.docker/config.json

.build-base: &build-base
  <<: *build
  stage: build
  script:
    - /kaniko/executor --build-arg BUILD_PHP_IMAGE --build-arg BUILD_PHP_VERSION --context ${CI_PROJECT_DIR}/base --destination ${DOCKERHUB_IMAGE_PATH}:${BUILD_PHP_VERSION}-${CI_COMMIT_TAG} --dockerfile ${CI_PROJECT_DIR}/base/Dockerfile

.build-dev: &build-dev
  <<: *build
  stage: build-dev
  script:
    - /kaniko/executor --build-arg BUILD_PHP_IMAGE --context ${CI_PROJECT_DIR}/dev --destination ${DOCKERHUB_IMAGE_PATH}:${BUILD_PHP_VERSION}-${CI_COMMIT_TAG}-dev --dockerfile ${CI_PROJECT_DIR}/dev/Dockerfile

.build-drupal: &build-drupal
  <<: *build
  stage: build-drupal
  script:
    - /kaniko/executor --build-arg BUILD_PHP_IMAGE --build-arg DRUSH_LAUNCHER_VERSION --context ${CI_PROJECT_DIR}/drupal --destination ${DOCKERHUB_IMAGE_PATH}:${BUILD_PHP_VERSION}-${CI_COMMIT_TAG}-drupal --dockerfile ${CI_PROJECT_DIR}/drupal/Dockerfile

.build-drupal-dev: &build-drupal-dev
  <<: *build
  stage: build-drupal
  script:
    - /kaniko/executor --build-arg BUILD_PHP_IMAGE --build-arg DRUSH_LAUNCHER_VERSION--build-arg BUILD_DEV=true --context ${CI_PROJECT_DIR}/drupal --destination ${DOCKERHUB_IMAGE_PATH}:${BUILD_PHP_VERSION}-${CI_COMMIT_TAG}-drupal-dev --dockerfile ${CI_PROJECT_DIR}/drupal/Dockerfile

build:7.2:
  <<: *build-base
  variables:
    BUILD_PHP_IMAGE: ${PHP72_BASE_IMAGE}
    BUILD_PHP_VERSION: '7.2'

build:7.2-dev:
  <<: *build-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.2-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.2'

build:7.2-drupal:
  <<: *build-drupal
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.2-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.2'

build:7.2-drupal-dev:
  <<: *build-drupal-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.2-${CI_COMMIT_TAG}-dev
    BUILD_PHP_VERSION: '7.2'

build:7.3:
  <<: *build-base
  variables:
    BUILD_PHP_IMAGE: ${PHP73_BASE_IMAGE}
    BUILD_PHP_VERSION: '7.3'

build:7.3-dev:
  <<: *build-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.3-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.3'

build:7.3-drupal:
  <<: *build-drupal
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.3-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.3'

build:7.3-drupal-dev:
  <<: *build-drupal-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.3-${CI_COMMIT_TAG}-dev
    BUILD_PHP_VERSION: '7.3'

build:7.4:
  <<: *build-base
  variables:
    BUILD_PHP_IMAGE: ${PHP74_BASE_IMAGE}
    BUILD_PHP_VERSION: '7.4'

build:7.4-dev:
  <<: *build-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.4-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.4'

build:7.4-drupal:
  <<: *build-drupal
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.4-${CI_COMMIT_TAG}
    BUILD_PHP_VERSION: '7.4'

build:7.4-drupal-dev:
  <<: *build-drupal-dev
  variables:
    BUILD_PHP_IMAGE: ${DOCKERHUB_IMAGE_PATH}:7.4-${CI_COMMIT_TAG}-dev
    BUILD_PHP_VERSION: '7.4'
